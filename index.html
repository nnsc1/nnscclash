<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NNSC Clash: Pro League</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root { --gold: #ffd700; --blue: #00d2ff; --red: #ff3131; --neon: #39ff14; --dark: #05050a; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: white; touch-action: none; }
        
        /* PWA Lock - Safari Specific */
        #pwa-enforce {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); z-index: 9999; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        .pwa-box { border: 2px solid var(--blue); padding: 30px; border-radius: 20px; background: #111; }

        #menu {
            position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a2e 0%, #000 100%);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 10px;
        }
        #locker-room-display { display: flex; justify-content: center; align-items: flex-end; gap: 15px; width: 100%; height: 160px; margin-bottom: 10px; }
        .locker-canvas { background: transparent; width: 70px; height: 110px; }
        
        .sel-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 95%; max-width: 800px; }
        .slot { background: rgba(255,255,255,0.05); border: 1px solid var(--blue); border-radius: 10px; padding: 5px; text-align: center; font-size: 0.65rem; }
        .cycle-btn { background: var(--blue); border: none; color: white; padding: 6px; border-radius: 5px; margin: 2px; }

        #hud { display: none; position: absolute; top: 10px; width: 100%; text-align: center; z-index: 60; pointer-events: none; }
        #scoreboard { font-size: 2rem; text-shadow: 2px 2px #000; font-style: italic; }
        #timer { font-size: 1rem; color: var(--gold); background: rgba(0,0,0,0.5); padding: 2px 10px; border-radius: 10px; display: inline-block; }

        #controls { display: none; position: absolute; bottom: 0; width: 100%; height: 180px; z-index: 50; }
        #joy-base { position: absolute; bottom: 30px; left: 30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid white; }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: white; border-radius: 50%; box-shadow: 0 0 10px white; }
        
        .btn-grid { position: absolute; bottom: 30px; right: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .g-btn { width: 65px; height: 65px; border-radius: 50%; border: 2px solid white; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }

        canvas { display: none; background: #1a472a; }
    </style>
</head>
<body>

<div id="pwa-enforce">
    <div class="pwa-box">
        <h2 style="color: var(--blue)">SAFARI INSTALL REQUIRED</h2>
        <p>1. Tap the <b>Share</b> button (square with arrow).</p>
        <p>2. Scroll down and tap <b>'Add to Home Screen'</b>.</p>
        <p>This ensures the game works in full-screen mode.</p>
    </div>
</div>

<div id="menu">
    <h1 style="color: var(--blue); margin: 5px; font-size: 1.2rem; font-style: italic;">NNSC LOCKER ROOM</h1>
    <div id="locker-room-display">
        <canvas id="pre-0" class="locker-canvas"></canvas>
        <canvas id="pre-1" class="locker-canvas"></canvas>
        <canvas id="pre-2" class="locker-canvas"></canvas>
        <canvas id="pre-3" class="locker-canvas"></canvas>
    </div>
    <div class="sel-grid" id="selectors"></div>
    <button style="margin-top: 10px; padding: 12px 60px; border-radius: 30px; background: var(--red); color: white; border: none; font-weight: bold; box-shadow: 0 0 20px var(--red);" onclick="startGame()">KICK OFF</button>
</div>

<div id="hud">
    <div id="scoreboard">BLUE 0 - 0 RED</div>
    <div id="timer">05:00</div>
</div>

<div id="controls">
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div class="btn-grid">
        <div class="g-btn" style="background: var(--blue)">PASS</div>
        <div class="g-btn" id="shoot-btn" style="background: #fff; color: #000;">SHOOT</div>
        <div class="g-btn" id="switch-btn" style="background: var(--gold); color: black;">SWITCH</div>
        <div class="g-btn" id="pwr-btn" style="background: var(--neon); color: black;">PWR</div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const PLAYER_DB = {
    '15Goalies': { nick: 'CHRIS B', skin: '#ffdbac' },
    '1300Melvin': { nick: 'MELVIN', skin: '#ffffff', hat: 'grad' },
    'angelolee1919': { nick: 'ANGELO', skin: '#8d5524', face: 'dog' },
    'CheekyBritishPerson1': { nick: 'CHEEKY', skin: '#ffffff' },
    'CristianoRonaldo9604': { nick: 'CRISTIANO', skin: '#c68642', face: 'dog' },
    'dvrianz': { nick: 'DVR', skin: '#444' },
    'E_Militao': { nick: 'EDER', skin: '#c68642' },
    'ElTatoYorugua': { nick: 'LEYENDA', skin: '#ffdbac', hat: 'redcap' },
    'EnesxRlo': { nick: 'ENES', skin: '#ffffff', antlers: true },
    'Fafumz': { nick: 'FAF', skin: '#ffffff' },
    'iHyperReal': { nick: 'ARDA', skin: '#444' },
    'J0ffPerc': { nick: 'J0FF', skin: '#333' },
    'JellozBenz': { nick: 'JELLO', skin: '#444', aura: true },
    'kenenmusss': { nick: 'KAAN', skin: '#444' },
    'mageman5304': { nick: 'MAGE', skin: '#333', hat: 'black' },
    'nascarremy16': { nick: 'REMY', skin: '#3d2b1f' },
    'petnilongo3': { nick: 'KAYN', skin: '#333', hat: 'diamond' },
    'psychx777': { nick: 'PSYCH', skin: '#ffffff', aura: true, antlers: true },
    'Salomaoarruda': { nick: 'SALAMANCA', skin: '#c68642' },
    'TG37074': { nick: 'TG', skin: '#333', face: 'fire' },
    'Tyranizard89': { nick: 'TYRAN', skin: '#8d5524', face: 'dino' }
};

const keys = Object.keys(PLAYER_DB);
let userTeamKeys = [keys[2], keys[5], keys[13], keys[1]];
let gameTime = 300;
let matchActive = false;
let score = [0, 0];
let joy = { x: 0, y: 0, active: false };
let players = [];
let ball = { x: 0, y: 0, vx: 0, vy: 0, r: 10 };

// PWA Logic for Safari
if (!window.navigator.standalone && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
    document.getElementById('pwa-enforce').style.display = 'flex';
}

function drawAvatar(ctx, x, y, k, teamColor, isSelected = false) {
    const data = PLAYER_DB[k];
    ctx.save();
    ctx.translate(x, y);

    // Selection Highlight (The Ring)
    if (isSelected) {
        ctx.shadowBlur = 15; ctx.shadowColor = '#39ff14';
        ctx.strokeStyle = '#39ff14'; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.ellipse(0, 22, 22, 10, 0, 0, 7); ctx.stroke();
        // Pulsing Arrow
        const bounce = Math.sin(Date.now() / 200) * 5;
        ctx.fillStyle = '#39ff14'; ctx.beginPath(); 
        ctx.moveTo(-8, -55 + bounce); ctx.lineTo(8, -55 + bounce); ctx.lineTo(0, -42 + bounce); ctx.fill();
        ctx.shadowBlur = 0;
    }

    // Body
    ctx.fillStyle = teamColor;
    ctx.beginPath(); ctx.roundRect(-15, 5, 30, 25, 5); ctx.fill();
    
    // Face Depth & Ears
    ctx.fillStyle = data.skin;
    ctx.beginPath(); ctx.arc(-14, -5, 4, 0, 7); ctx.fill(); // Left Ear
    ctx.beginPath(); ctx.arc(14, -5, 4, 0, 7); ctx.fill();  // Right Ear
    ctx.beginPath(); ctx.arc(0, -5, 15, 0, 7); ctx.fill();

    // Eyes (More Realistic)
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(-6, -7, 4, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.arc(6, -7, 4, 0, 7); ctx.fill();
    ctx.fillStyle = '#222';
    ctx.beginPath(); ctx.arc(-6, -7, 2, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.arc(6, -7, 2, 0, 7); ctx.fill();

    // Traits
    if(data.face === 'dog') { ctx.fillStyle='#444'; ctx.beginPath(); ctx.arc(-15, -5, 6, 0, 7); ctx.fill(); ctx.beginPath(); ctx.arc(15, -5, 6, 0, 7); ctx.fill(); }
    if(data.hat === 'grad') { ctx.fillStyle='black'; ctx.fillRect(-14,-20,28,4); ctx.fillRect(-2,-25,4,10); }

    ctx.fillStyle = 'white'; ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center';
    ctx.fillText(data.nick, 0, -32);
    ctx.restore();
}

// Position Logic AI
function getPositionGoal(p, cw, ch) {
    const isU = p.team === 'u';
    const side = isU ? 0 : cw;
    switch(p.posType) {
        case 0: return { x: isU ? 60 : cw - 60, y: Math.max(ch/2-60, Math.min(ch/2+60, ball.y)) }; // GK
        case 1: return { x: isU ? 200 : cw - 200, y: ball.y * 0.5 + ch/4 }; // DEF
        case 2: return { x: cw/2 + (isU ? -100 : 100), y: ball.y }; // MID
        case 3: return { x: ball.x, y: ball.y }; // ATT
    }
}

// Locker Room System
const selDiv = document.getElementById('selectors');
["GK", "DEF", "MID", "ATT"].forEach((pos, i) => {
    selDiv.innerHTML += `<div class="slot"><b>${pos}</b><br><span id="name-${i}">${PLAYER_DB[userTeamKeys[i]].nick}</span><br>
    <button class="cycle-btn" onclick="cycle(${i},-1)">◀</button> <button class="cycle-btn" onclick="cycle(${i},1)">▶</button></div>`;
});

function cycle(slot, dir) {
    let idx = keys.indexOf(userTeamKeys[slot]);
    do { idx = (idx + dir + keys.length) % keys.length; } while (userTeamKeys.includes(keys[idx]));
    userTeamKeys[slot] = keys[idx];
    document.getElementById(`name-${slot}`).innerText = PLAYER_DB[userTeamKeys[slot]].nick;
    renderLocker();
}

function renderLocker() {
    userTeamKeys.forEach((k, i) => {
        const c = document.getElementById(`pre-${i}`);
        const ctxP = c.getContext('2d');
        ctxP.clearRect(0,0,c.width,c.height);
        drawAvatar(ctxP, c.width/2, 60, k, '#00d2ff', false);
    });
}
renderLocker();

function startGame() {
    document.getElementById('menu').style.display = 'none';
    const gameCanvas = document.getElementById('gameCanvas');
    gameCanvas.style.display = 'block';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    gameCanvas.width = window.innerWidth; gameCanvas.height = window.innerHeight;
    
    score = [0,0]; gameTime = 300; matchActive = true;
    let comKeys = keys.filter(k => !userTeamKeys.includes(k)).sort(() => 0.5 - Math.random()).slice(0, 4);
    
    players = [];
    userTeamKeys.forEach((k, i) => players.push({ key: k, team: 'u', posType: i, x: 100, y: 100*i, cur: i===3, s: 4.5 }));
    comKeys.forEach((k, i) => players.push({ key: k, team: 'c', posType: i, x: gameCanvas.width-100, y: 100*i, cur: false, s: 3.8 }));
    
    ball = { x: gameCanvas.width/2, y: gameCanvas.height/2, vx: 0, vy: 0, r: 10 };
    requestAnimationFrame(loop);
}

function loop() {
    if (!matchActive) return;
    const ctx = document.getElementById('gameCanvas').getContext('2d');
    const cw = window.innerWidth, ch = window.innerHeight;

    ctx.fillStyle = '#1a472a'; ctx.fillRect(0,0,cw,ch);
    // Grass Texture
    ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 2;
    for(let i=0; i<cw; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,ch); ctx.stroke(); }

    ball.x += ball.vx; ball.y += ball.vy;
    ball.vx *= 0.985; ball.vy *= 0.985;

    // Boundaries
    if(ball.y < ball.r || ball.y > ch-ball.r) ball.vy *= -1;
    if(ball.x < ball.r || ball.x > cw-ball.r) {
        if(ball.y > ch/2-80 && ball.y < ch/2+80) {
            if(ball.x < cw/2) score[1]++; else score[0]++;
            ball.x = cw/2; ball.y = ch/2; ball.vx=0; ball.vy=0;
        } else { ball.vx *= -1; }
    }
    ball.x = Math.max(ball.r, Math.min(cw-ball.r, ball.x));
    ball.y = Math.max(ball.r, Math.min(ch-ball.r, ball.y));

    players.forEach(p => {
        if(p.cur) { p.x += joy.x*p.s; p.y += joy.y*p.s; }
        else {
            let target = getPositionGoal(p, cw, ch);
            let dx = target.x - p.x, dy = target.y - p.y;
            let dist = Math.sqrt(dx*dx+dy*dy);
            if(dist > 5) { p.x += (dx/dist)*p.s; p.y += (dy/dist)*p.s; }
        }
        p.x = Math.max(20, Math.min(cw-20, p.x));
        p.y = Math.max(20, Math.min(ch-20, p.y));

        let dx = ball.x-p.x, dy = ball.y-p.y, d = Math.sqrt(dx*dx+dy*dy);
        if(d < 25) { ball.vx = dx*0.6; ball.vy = dy*0.6; }
        drawAvatar(ctx, p.x, p.y, p.key, p.team==='u'?'#00d2ff':'#ff3131', p.cur);
    });

    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, 7); ctx.fill();
    document.getElementById('scoreboard').innerText = `BLUE ${score[0]} - ${score[1]} RED`;
    requestAnimationFrame(loop);
}

// Controller Logic
window.addEventListener('touchstart', e => {
    const t = e.touches[0];
    const b = document.getElementById('joy-base').getBoundingClientRect();
    if(t.clientX > b.left && t.clientX < b.right) joy.active = true;
    if(e.target.id === 'switch-btn') {
        let idx = players.findIndex(p => p.cur); players[idx].cur = false;
        players[(idx + 1) % 4].cur = true;
    }
    if(e.target.id === 'shoot-btn') {
        let p = players.find(p => p.cur);
        let dx = (p.team==='u'?window.innerWidth:0)-p.x, dy = (window.innerHeight/2)-p.y, d = Math.sqrt(dx*dx+dy*dy);
        ball.vx = (dx/d)*20; ball.vy = (dy/d)*20;
    }
});
window.addEventListener('touchmove', e => {
    if(!joy.active) return;
    const t = e.touches[0];
    const b = document.getElementById('joy-base').getBoundingClientRect();
    joy.x = (t.clientX - (b.left + 50)) / 40; joy.y = (t.clientY - (b.top + 50)) / 40;
    document.getElementById('joy-stick').style.transform = `translate(${Math.max(-40, Math.min(40, joy.x*40))}px, ${Math.max(-40, Math.min(40, joy.y*40))}px)`;
});
window.addEventListener('touchend', () => { joy.active=false; joy.x=0; joy.y=0; document.getElementById('joy-stick').style.transform=`translate(0,0)`; });

// Timer Logic
setInterval(() => { if(matchActive && gameTime > 0) {
    gameTime--;
    let m = Math.floor(gameTime/60), s = gameTime%60;
    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
}}, 1000);
</script>
</body>
</html>
