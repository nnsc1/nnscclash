<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NNSC Clash - Fixed</title>
    <style>
        :root { --gold: #ffd700; --blue: #00d2ff; --red: #ff3131; --neon: #39ff14; --dark: #05050a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: white; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        /* UI LAYERS */
        #pwa-lock { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 20000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .ios-icon { width: 40px; height: 40px; background: white; border-radius: 8px; margin: 10px; color: black; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        #orientation-lock { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 10000; align-items: center; justify-content: center; }
        @media (orientation: portrait) { #orientation-lock { display: flex; } }

        #mvp-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center;
        }
        .mvp-card { 
            background: linear-gradient(145deg, #222, #000); border: 3px solid var(--gold); border-radius: 20px;
            padding: 30px; text-align: center; box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            animation: mvpSlide 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes mvpSlide { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #menu { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a2e 0%, #000 100%); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .sel-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 95%; max-width: 700px; margin-top: 20px; }
        .slot { background: rgba(255,255,255,0.05); border: 2px solid var(--blue); border-radius: 8px; padding: 10px; text-align: center; font-size: 0.7rem; }
        .slot button { margin-top: 5px; padding: 5px 10px; cursor: pointer; background: var(--blue); border: none; color: white; border-radius: 4px; font-weight: bold; }
        
        #hud { display: none; position: absolute; top: 10px; width: 100%; text-align: center; z-index: 60; pointer-events: none; }
        
        #controls { display: none; position: absolute; bottom: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        /* Left Joystick Zone */
        #joy-zone { position: absolute; bottom: 0; left: 0; width: 40%; height: 60%; pointer-events: auto; }
        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); display: none; }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; pointer-events: none; }
        
        /* Right Buttons */
        .btn-grid { position: absolute; bottom: 30px; right: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; pointer-events: auto; }
        .g-btn { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .g-btn:active { transform: scale(0.9); opacity: 0.8; }
        
        #goal-banner { display: none; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 200; text-align: center; }
        #flash-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: white; opacity: 0; pointer-events: none; z-index: 199; transition: opacity 0.1s; }
        #gameCanvas { display: none; width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="pwa-lock">
    <h2 style="color: var(--gold)">NNSC CLASH</h2>
    <p>Add to Home Screen to Play</p>
    <div style="display:flex; align-items:center; gap: 10px;">
        <div>1. Tap <span class="ios-icon">⎋</span></div>
        <div>2. "Add to Home Screen" <span class="ios-icon">+</span></div>
    </div>
</div>

<div id="orientation-lock"><div><h2 style="color: var(--gold)">ROTATE TO PLAY</h2><p>↻ Turn your device landscape</p></div></div>
<div id="flash-overlay"></div>

<div id="mvp-overlay">
    <div class="mvp-card">
        <div style="color: var(--gold); font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 10px;">MATCH MVP</div>
        <canvas id="mvp-canvas" width="100" height="120"></canvas>
        <h2 id="mvp-name" style="margin: 10px 0;">PLAYER</h2>
        <div id="mvp-stats" style="font-size: 0.8rem; color: #aaa;">Goals: 0 | Touches: 0</div>
        <button style="margin-top: 20px; padding: 12px 40px; background: var(--blue); color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer;" onclick="location.reload()">REMATCH</button>
    </div>
</div>

<div id="goal-banner">
    <div style="font-size: 3rem; color: var(--gold); font-style: italic; text-shadow: 0 0 20px var(--gold);">GOAL!</div>
    <div id="scorer-name" style="font-size: 1.5rem; margin-top: 10px;">PLAYER</div>
</div>

<div id="menu">
    <h1 style="color: var(--gold); margin-bottom: 30px; text-shadow: 0 0 10px var(--blue);">NNSC CLASH</h1>
    <div id="locker-room-display" style="display:flex; gap:10px; margin-bottom: 20px;">
        <canvas id="pre-0" width="60" height="90"></canvas>
        <canvas id="pre-1" width="60" height="90"></canvas>
        <canvas id="pre-2" width="60" height="90"></canvas>
        <canvas id="pre-3" width="60" height="90"></canvas>
    </div>
    <div class="sel-grid" id="selectors"></div>
    <button style="margin-top: 30px; padding: 15px 60px; border-radius: 30px; background: var(--red); color: white; border: none; font-weight: 900; font-size: 1.2rem; cursor: pointer; box-shadow: 0 0 20px var(--red);" onclick="startGame()">KICK OFF</button>
</div>

<div id="hud">
    <div id="scoreboard" style="font-size: 1.8rem; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">BLUE 0 - 0 RED</div>
    <div id="timer" style="color: var(--gold); font-size: 1.2rem; margin-top: 5px;">05:00</div>
</div>

<div id="controls">
    <div id="joy-zone">
        <div id="joy-base"><div id="joy-stick"></div></div>
    </div>
    <div class="btn-grid">
        <div class="g-btn" id="pass-btn" style="background: var(--blue);">PASS</div>
        <div class="g-btn" id="shoot-btn" style="background: var(--red);">SHOOT</div>
        <div class="g-btn" id="switch-btn" style="background: var(--gold); color: black;">SWITCH</div>
        <div class="g-btn" id="tackle-btn" style="background: var(--neon); color: black;">TACKLE</div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
// --- DB & CONFIG ---
const PLAYER_DB = {
    'angelolee1919': { nick: 'ANGELO', pwr: 'DOG POWER', skin: '#8d5524' },
    'Tyranizard89': { nick: 'TYRAN', pwr: 'DINOSAUR', skin: '#8d5524' },
    'TG37074': { nick: 'TG', pwr: 'YES SAR', skin: '#333' },
    'dvrianz': { nick: 'DVR', pwr: 'OG PLAYER', skin: '#444' },
    'NETHQES2': { nick: 'NETH', pwr: 'GOOD BROS', skin: '#ffdbac' },
    'J0ffPerc': { nick: 'J0FF', pwr: 'GYM', skin: '#333' },
    'EnesxRlo': { nick: 'ENES', pwr: 'TACKLE', skin: '#ffffff' },
    'E_Militao': { nick: 'EDER', pwr: 'SHUTDOWN', skin: '#c68642' },
    'mageman5304': { nick: 'MAGE', pwr: 'LOCKDOWN', skin: '#333' },
    'iHyperReal': { nick: 'ARDA', pwr: 'TYPEWRITER', skin: '#444' },
    '15Goalies': { nick: 'CHRIS B', pwr: 'ROOKIE', skin: '#ffdbac' },
    'CristianoRonaldo9604': { nick: 'CR7', pwr: 'DOG POWER', skin: '#c68642' },
    'JellozBenz': { nick: 'JELLO', pwr: 'OG PLAYER', skin: '#444' },
    'kenenmusss': { nick: 'KAAN', pwr: 'ASKIM', skin: '#444' },
    'ElTatoYorugua': { nick: 'LEYENDA', pwr: 'MILANESA', skin: '#ffdbac' },
    'petnilongo3': { nick: 'KAYN', pwr: 'FEIJOADA', skin: '#333' },
    '1300Melvin': { nick: 'MELVIN', pwr: 'DEPENDENCY', skin: '#ffffff' },
    'nascarremy16': { nick: 'REMY', pwr: 'INVIS', skin: '#3d2b1f' },
    'CheekyBritishPerson1': { nick: 'CHEEKY', pwr: 'SIDHU', skin: '#ffffff' },
    'psychx777': { nick: 'PSYCH', pwr: '7', skin: '#ffffff' },
    'Salomaoarruda': { nick: 'SALAMANCA', pwr: 'EGOIST', skin: '#c68642' }
};

let userTeamKeys = [Object.keys(PLAYER_DB)[0], Object.keys(PLAYER_DB)[3], Object.keys(PLAYER_DB)[7], Object.keys(PLAYER_DB)[10]];
let comTeamKeys = [], players = [];
// Added cooldown to ball to prevent instant dispossess flickering
let ball = { x: 0, y: 0, vx: 0, vy: 0, r: 8, lastTouch: null, owner: null, cooldown: 0 };
let matchActive = false, score = [0, 0], matchTime = 300;
let timerInt = null;
let isCelebrating = false;
let joy = { x: 0, y: 0, active: false, id: null, originX: 0, originY: 0 };

// --- HELPERS ---
function drawAvatar(ctx, x, y, k, color, isSelected = false, pObj = null) {
    if(!PLAYER_DB[k]) return; // Safety check
    const d = PLAYER_DB[k];
    ctx.save();
    ctx.translate(x, y);
    
    // Selection Halo
    if (isSelected) {
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#39ff14'; 
    }

    // Shirt
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.rect(-12, 5, 24, 18);
    ctx.fill();
    
    // Head
    ctx.shadowBlur = 0;
    ctx.fillStyle = d.skin;
    ctx.beginPath();
    ctx.arc(0, -5, 11, 0, Math.PI * 2);
    ctx.fill();
    
    // Eyes
    ctx.fillStyle = 'black';
    ctx.beginPath();
    ctx.arc(-4, -6, 1.5, 0, Math.PI * 2);
    ctx.arc(4, -6, 1.5, 0, Math.PI * 2);
    ctx.fill();
    
    // Selection Ring
    if (isSelected) {
        ctx.strokeStyle = '#39ff14';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(0, 0, 22, 0, Math.PI * 2);
        ctx.stroke();
        
        // Direction Arrow
        if(pObj) {
            ctx.rotate(pObj.angle);
            ctx.beginPath();
            ctx.moveTo(26, 0);
            ctx.lineTo(32, 0);
            ctx.stroke();
            ctx.rotate(-pObj.angle);
        }
    }
    
    // Name Tag
    ctx.fillStyle = 'white';
    ctx.font = '900 10px Arial';
    ctx.textAlign = 'center';
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'black';
    ctx.strokeText(d.nick, 0, -22);
    ctx.fillText(d.nick, 0, -22);
    
    ctx.restore();
}

function startGame() {
    document.getElementById('menu').style.display = 'none';
    const canvas = document.getElementById('gameCanvas');
    canvas.style.display = 'block';
    document.getElementById('hud').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    
    resizeCanvas();
    
    comTeamKeys = Object.keys(PLAYER_DB)
        .filter(k => !userTeamKeys.includes(k))
        .sort(() => 0.5 - Math.random())
        .slice(0, 4);
    
    players = [];
    
    // Create Players with Safe defaults
    userTeamKeys.forEach((k, i) => {
        players.push({
            key: k, team: 'u', pos: i,
            x: canvas.width * 0.2, y: (canvas.height / 5) * (i + 1),
            cur: i === 3, s: 4.5, goals: 0, touches: 0, angle: 0, tackleTimer: 0
        });
    });
    
    comTeamKeys.forEach((k, i) => {
        players.push({
            key: k, team: 'c', pos: i,
            x: canvas.width * 0.8, y: (canvas.height / 5) * (i + 1),
            cur: false, s: 4.0, goals: 0, touches: 0, angle: Math.PI, tackleTimer: 0
        });
    });
    
    resetBall();
    matchActive = true;
    matchTime = 300;
    score = [0, 0];
    isCelebrating = false;
    
    requestAnimationFrame(loop);
    
    if (timerInt) clearInterval(timerInt);
    timerInt = setInterval(() => {
        if (matchActive && !isCelebrating) {
            matchTime--;
            let m = Math.floor(matchTime / 60);
            let s = matchTime % 60;
            document.getElementById('timer').innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            if (matchTime <= 0) {
                clearInterval(timerInt);
                showMVP();
            }
        }
    }, 1000);
}

function resetBall() {
    const canvas = document.getElementById('gameCanvas');
    ball = {
        x: canvas.width / 2, y: canvas.height / 2,
        vx: 0, vy: 0, r: 8, lastTouch: null, owner: null, cooldown: 60 // 1 sec cooldown on spawn
    };
    // Reset players slightly
    players.forEach(p => {
        p.x = p.team === 'u' ? canvas.width * 0.2 : canvas.width * 0.8;
        p.y = (canvas.height / 5) * (p.pos + 1);
    });
}

function handleGoal(tIdx) {
    score[tIdx]++;
    isCelebrating = true;
    if (ball.lastTouch) ball.lastTouch.goals++;
    
    document.getElementById('scorer-name').innerText = ball.lastTouch ? PLAYER_DB[ball.lastTouch.key].nick : "GOAL";
    document.getElementById('goal-banner').style.display = 'block';
    document.getElementById('flash-overlay').style.opacity = '1';
    
    setTimeout(() => document.getElementById('flash-overlay').style.opacity = '0', 100);
    setTimeout(() => {
        isCelebrating = false;
        document.getElementById('goal-banner').style.display = 'none';
        resetBall();
    }, 3000);
}

function showMVP() {
    matchActive = false;
    document.getElementById('mvp-overlay').style.display = 'flex';
    const mvp = players.sort((a, b) => (b.goals * 10 + b.touches) - (a.goals * 10 + a.touches))[0];
    document.getElementById('mvp-name').innerText = PLAYER_DB[mvp.key].nick;
    document.getElementById('mvp-stats').innerText = `Goals: ${mvp.goals} | Touches: ${mvp.touches}`;
    const mvpCtx = document.getElementById('mvp-canvas').getContext('2d');
    mvpCtx.clearRect(0, 0, 100, 120);
    drawAvatar(mvpCtx, 50, 60, mvp.key, mvp.team === 'u' ? '#00d2ff' : '#ff3131');
}

// --- MAIN LOOP ---
function loop() {
    if (!matchActive) return;
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const cw = canvas.width;
    const ch = canvas.height;
    
    // Draw Field
    ctx.fillStyle = '#1a472a';
    ctx.fillRect(0, 0, cw, ch);
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
    ctx.strokeRect(40, 20, cw - 80, ch - 40);
    ctx.beginPath(); ctx.moveTo(cw/2, 20); ctx.lineTo(cw/2, ch-20); ctx.stroke();
    ctx.beginPath(); ctx.arc(cw/2, ch/2, 50, 0, Math.PI*2); ctx.stroke();
    
    // Goals
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.fillRect(10, ch/2 - 60, 30, 120);
    ctx.fillRect(cw - 40, ch/2 - 60, 30, 120);
    
    // Logic Updates
    if (!isCelebrating) {
        if (ball.cooldown > 0) ball.cooldown--;
        
        // Ball Physics
        if (ball.owner) {
            ball.x = ball.owner.x + Math.cos(ball.owner.angle) * 18;
            ball.y = ball.owner.y + Math.sin(ball.owner.angle) * 18;
            ball.vx = 0; ball.vy = 0;
            ball.lastTouch = ball.owner;
        } else {
            ball.x += ball.vx;
            ball.y += ball.vy;
            ball.vx *= 0.96; // Slightly more friction for better feel
            ball.vy *= 0.96;
            
            // Walls
            if (ball.y < 28 || ball.y > ch - 28) ball.vy *= -0.8;
            if (ball.x < 45 || ball.x > cw - 45) {
                if (ball.y > ch/2 - 60 && ball.y < ch/2 + 60) {
                    handleGoal(ball.x < cw/2 ? 1 : 0);
                } else {
                    ball.vx *= -0.8;
                }
            }
        }
    }
    
    // Find Closest AI (Safe Filter)
    const comPlayers = players.filter(p => p.team === 'c');
    let closestCom = null;
    if(comPlayers.length > 0) {
        closestCom = comPlayers.reduce((prev, curr) => {
            return Math.hypot(curr.x - ball.x, curr.y - ball.y) < Math.hypot(prev.x - ball.x, prev.y - ball.y) ? curr : prev;
        });
    }

    // Player Movement & Logic
    players.forEach(p => {
        if (!isCelebrating) {
            let dx = 0, dy = 0;
            
            if (p.cur) {
                // User Control
                if (joy.active) {
                    dx = joy.x * p.s;
                    dy = joy.y * p.s;
                    if (Math.abs(joy.x) > 0.1 || Math.abs(joy.y) > 0.1) {
                        p.angle = Math.atan2(joy.y, joy.x);
                    }
                }
            } else {
                // AI / Auto-Pos Logic
                let tx, ty;
                
                if (p.team === 'c') {
                    // Enemy AI
                    if (p === closestCom) {
                        // Chaser
                        tx = ball.x;
                        ty = ball.y;
                    } else {
                        // Support / Formation - Don't bunch up!
                        let homeX = cw * (p.pos === 0 ? 0.9 : 0.7);
                        let homeY = (ch / 5) * (p.pos + 1);
                        tx = homeX + (ball.x - cw/2) * 0.3; // Shift slightly with play
                        ty = homeY;
                    }
                } else {
                    // Teammate AI
                    if (p.pos === 0) { // GK
                        tx = cw * 0.1;
                        ty = Math.max(ch/2 - 40, Math.min(ch/2 + 40, ball.y));
                    } else {
                        let homeX = ball.x + (p.pos === 1 ? -100 : (p.pos === 2 ? -100 : 0));
                        let homeY = (ch / 5) * (p.pos + 1);
                        tx = Math.max(cw * 0.15, Math.min(cw * 0.9, homeX));
                        ty = homeY;
                    }
                }
                
                let distX = tx - p.x;
                let distY = ty - p.y;
                let dist = Math.hypot(distX, distY);
                
                // MATH FIX: Prevent NaN freezing by checking distance
                if (dist > 5) {
                    dx = (distX / dist) * (p.s * 0.85); // AI is slightly slower
                    dy = (distY / dist) * (p.s * 0.85);
                    p.angle = Math.atan2(dy, dx);
                }
            }
            
            p.x += dx;
            p.y += dy;
            
            // Collision / Stealing Logic
            let dBall = Math.hypot(p.x - ball.x, p.y - ball.y);
            if (dBall < 20) {
                if (ball.cooldown <= 0) {
                    if (!ball.owner) {
                        // Free ball -> Take it
                        ball.owner = p;
                        p.touches++;
                        ball.cooldown = 15; // Brief shield
                    } else if (ball.owner !== p && ball.owner.team !== p.team) {
                        // Opponent has ball -> Can we steal?
                        // Only steal if tackling or random chance is very low (prevent flicker)
                        // Tackle button handles the forced steal. Here is passive interception.
                    }
                }
            }
        }
        
        // Boundaries
        p.x = Math.max(30, Math.min(cw - 30, p.x));
        p.y = Math.max(20, Math.min(ch - 20, p.y));
        
        drawAvatar(ctx, p.x, p.y, p.key, p.team === 'u' ? '#00d2ff' : '#ff3131', p.cur, p);
    });
    
    // Draw Ball
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = 'black'; ctx.lineWidth = 1; ctx.stroke();
    
    // Possession Ring
    if (ball.owner) {
        ctx.strokeStyle = ball.cooldown > 0 ? 'white' : '#39ff14'; // White if shielded
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(ball.owner.x, ball.owner.y + 2, 24, 0, Math.PI*2); ctx.stroke();
    }
    
    document.getElementById('scoreboard').innerText = `BLUE ${score[0]} - ${score[1]} RED`;
    requestAnimationFrame(loop);
}

// --- ACTIONS ---
function kickBall(power) {
    if (ball.owner && ball.owner.cur) {
        let p = ball.owner;
        ball.owner = null;
        ball.vx = Math.cos(p.angle) * power;
        ball.vy = Math.sin(p.angle) * power;
        ball.cooldown = 10; // Prevent instant self-catch
    }
}

function attemptTackle() {
    let p = players.find(x => x.cur);
    if(p) {
        // Dash
        p.x += Math.cos(p.angle) * 40;
        p.y += Math.sin(p.angle) * 40;
        
        // Steal Check
        if(ball.owner && ball.owner.team !== 'u') {
            let dist = Math.hypot(p.x - ball.owner.x, p.y - ball.owner.y);
            if(dist < 35) {
                ball.owner = p;
                ball.cooldown = 40; // Long shield after tackle
                p.touches++;
                document.getElementById('flash-overlay').style.opacity = '0.4';
                setTimeout(() => document.getElementById('flash-overlay').style.opacity = '0', 50);
            }
        }
    }
}

function switchPlayer() {
    let currentIdx = players.findIndex(p => p.cur);
    if (currentIdx >= 0) players[currentIdx].cur = false;
    
    // Find closest player to ball on User team
    let bestP = players.filter(p => p.team === 'u').reduce((prev, curr) => 
        Math.hypot(curr.x - ball.x, curr.y - ball.y) < Math.hypot(prev.x - ball.x, prev.y - ball.y) ? curr : prev
    );
    bestP.cur = true;
}

// --- INPUTS ---
const joyZone = document.getElementById('joy-zone');
const joyBase = document.getElementById('joy-base');
const joyStick = document.getElementById('joy-stick');

joyZone.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.changedTouches[0];
    joy.id = touch.identifier;
    joy.active = true;
    joy.originX = touch.clientX;
    joy.originY = touch.clientY;
    
    joyBase.style.display = 'block';
    joyBase.style.left = (joy.originX - 50) + 'px';
    joyBase.style.top = (joy.originY - 50) + 'px';
    joyStick.style.left = '25px'; joyStick.style.top = '25px';
    joy.x = 0; joy.y = 0;
}, {passive: false});

joyZone.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!joy.active) return;
    
    for(let i=0; i<e.changedTouches.length; i++) {
        if(e.changedTouches[i].identifier === joy.id) {
            const touch = e.changedTouches[i];
            let dx = touch.clientX - joy.originX;
            let dy = touch.clientY - joy.originY;
            let dist = Math.hypot(dx, dy);
            let maxDist = 50;
            
            if(dist > maxDist) {
                dx = (dx/dist) * maxDist;
                dy = (dy/dist) * maxDist;
            }
            
            joy.x = dx / maxDist;
            joy.y = dy / maxDist;
            
            joyStick.style.left = (25 + dx) + 'px';
            joyStick.style.top = (25 + dy) + 'px';
        }
    }
}, {passive: false});

const endJoy = (e) => {
    e.preventDefault();
    for(let i=0; i<e.changedTouches.length; i++) {
        if(e.changedTouches[i].identifier === joy.id) {
            joy.active = false;
            joy.x = 0; joy.y = 0;
            joyBase.style.display = 'none';
        }
    }
};
joyZone.addEventListener('touchend', endJoy);
joyZone.addEventListener('touchcancel', endJoy);

// Buttons
document.getElementById('shoot-btn').addEventListener('touchstart', (e) => { e.preventDefault(); kickBall(22); });
document.getElementById('pass-btn').addEventListener('touchstart', (e) => { e.preventDefault(); kickBall(12); });
document.getElementById('switch-btn').addEventListener('touchstart', (e) => { e.preventDefault(); switchPlayer(); });
document.getElementById('tackle-btn').addEventListener('touchstart', (e) => { e.preventDefault(); attemptTackle(); });

// Keyboard Support
window.addEventListener('keydown', (e) => {
    if(e.code === 'Space') kickBall(22);
    if(e.code === 'KeyV') kickBall(12);
    if(e.code === 'KeyC') switchPlayer();
    if(e.code === 'KeyX') attemptTackle();
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) {
        joy.active = true;
        if(e.code==='ArrowUp') joy.y = -1;
        if(e.code==='ArrowDown') joy.y = 1;
        if(e.code==='ArrowLeft') joy.x = -1;
        if(e.code==='ArrowRight') joy.x = 1;
    }
});
window.addEventListener('keyup', (e) => {
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) {
        joy.active = false; joy.x = 0; joy.y = 0;
    }
});

// Setup Menu
const keys = Object.keys(PLAYER_DB);
const selDiv = document.getElementById('selectors');
["GK", "DEF", "MID", "ATT"].forEach((pos, i) => {
    const slot = document.createElement('div');
    slot.className = 'slot';
    slot.innerHTML = `<b style="color:var(--gold)">${pos}</b><br><span id="n-${i}" style="margin:5px 0;display:block">${PLAYER_DB[userTeamKeys[i]].nick}</span><button onclick="cycle(${i})">CHANGE</button>`;
    selDiv.appendChild(slot);
});
function cycle(s) {
    let i = keys.indexOf(userTeamKeys[s]);
    do { i = (i + 1) % keys.length; } while (userTeamKeys.includes(keys[i]));
    userTeamKeys[s] = keys[i];
    document.getElementById(`n-${s}`).innerText = PLAYER_DB[userTeamKeys[s]].nick;
    const ctx = document.getElementById(`pre-${s}`).getContext('2d');
    ctx.clearRect(0,0,60,90);
    drawAvatar(ctx, 30, 45, userTeamKeys[s], '#00d2ff');
}
// Initial Draw
setTimeout(() => {
    userTeamKeys.forEach((k, i) => {
        const ctx = document.getElementById(`pre-${i}`).getContext('2d');
        drawAvatar(ctx, 30, 45, k, '#00d2ff');
    });
}, 100);

function resizeCanvas() {
    const canvas = document.getElementById('gameCanvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

// --- AI SHOOTING LOOP ---
setInterval(() => {
    if(!matchActive) return;
    const carrier = players.find(p => ball.owner === p);
    if(carrier && carrier.team === 'c') {
        const distToGoal = Math.hypot(carrier.x - 0, carrier.y - window.innerHeight/2);
        if(distToGoal < 350) {
            // AI Shoot
            const angleToGoal = Math.atan2((window.innerHeight/2) - carrier.y, 0 - carrier.x);
            ball.owner = null;
            ball.vx = Math.cos(angleToGoal + (Math.random()-0.5)*0.2) * 20;
            ball.vy = Math.sin(angleToGoal + (Math.random()-0.5)*0.2) * 20;
            ball.cooldown = 10;
        } else if (Math.random() > 0.95) {
            // AI Pass sometimes
            ball.owner = null;
            ball.vx = Math.cos(carrier.angle) * 15;
            ball.vy = Math.sin(carrier.angle) * 15;
        }
    }
}, 600);
</script>
</body>
</html>
